<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cont√°bilApp - Gest√£o Pessoal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            50: 'rgb(var(--c-slate-50) / <alpha-value>)',
                            100: 'rgb(var(--c-slate-100) / <alpha-value>)',
                            200: 'rgb(var(--c-slate-200) / <alpha-value>)',
                            300: 'rgb(var(--c-slate-300) / <alpha-value>)',
                            400: 'rgb(var(--c-slate-400) / <alpha-value>)',
                            500: 'rgb(var(--c-slate-500) / <alpha-value>)',
                            600: 'rgb(var(--c-slate-600) / <alpha-value>)',
                            700: 'rgb(var(--c-slate-700) / <alpha-value>)',
                            800: 'rgb(var(--c-slate-800) / <alpha-value>)',
                            900: 'rgb(var(--c-slate-900) / <alpha-value>)',
                        },
                        indigo: {
                            50: 'rgb(var(--c-indigo-50) / <alpha-value>)',
                            100: 'rgb(var(--c-indigo-100) / <alpha-value>)',
                            200: 'rgb(var(--c-indigo-200) / <alpha-value>)',
                            300: 'rgb(var(--c-indigo-300) / <alpha-value>)',
                            400: 'rgb(var(--c-indigo-400) / <alpha-value>)',
                            500: 'rgb(var(--c-indigo-500) / <alpha-value>)',
                            600: 'rgb(var(--c-indigo-600) / <alpha-value>)',
                            700: 'rgb(var(--c-indigo-700) / <alpha-value>)',
                            800: 'rgb(var(--c-indigo-800) / <alpha-value>)',
                            900: 'rgb(var(--c-indigo-900) / <alpha-value>)',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            /* Default Light Mode (Standard Tailwind Colors) */
            --c-slate-50: 248 250 252; --c-slate-100: 241 245 249; --c-slate-200: 226 232 240;
            --c-slate-300: 203 213 225; --c-slate-400: 148 163 184; --c-slate-500: 100 116 139;
            --c-slate-600: 71 85 105; --c-slate-700: 51 65 85; --c-slate-800: 30 41 59; --c-slate-900: 15 23 42;
            
            --c-indigo-50: 238 242 255; --c-indigo-100: 224 231 255; --c-indigo-200: 199 210 254;
            --c-indigo-300: 165 180 252; --c-indigo-400: 129 140 248; --c-indigo-500: 99 102 241;
            --c-indigo-600: 79 70 229; --c-indigo-700: 67 56 202; --c-indigo-800: 55 48 163; --c-indigo-900: 49 46 129;
        }

        /* Salvati Theme (Wine BG, Navy Accents) */
        .theme-salvati {
            /* Backgrounds (Slate) -> Wine Tones */
            --c-slate-900: 76 5 25;   /* Rose 950 (Main BG) */
            --c-slate-800: 136 19 55; /* Rose 900 (Card BG) */
            --c-slate-700: 159 18 57; /* Rose 800 (Borders/Inputs) */
            --c-slate-600: 190 18 60; /* Rose 700 */
            
            /* Accents (Indigo) -> Navy Blue Tones */
            --c-indigo-50: 239 246 255;
            --c-indigo-100: 219 234 254;
            --c-indigo-400: 96 165 250;
            --c-indigo-500: 59 130 246;
            --c-indigo-600: 30 58 138;  /* Blue 800 (Primary) */
            --c-indigo-700: 23 37 84;   /* Blue 950 (Hover) */
        }

        .theme-salvati body {
            background-image: url('https://images.unsplash.com/photo-1518837695005-2083093ee35b?auto=format&fit=crop&q=80&w=2000');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-blend-mode: multiply;
        }

        /* Marinho Theme (Navy BG, Wine Accents) */
        .theme-marinho {
            /* Backgrounds (Slate) -> Navy Tones (Standard Dark is already Navy, ensuring consistency) */
            --c-slate-900: 15 23 42;
            --c-slate-800: 30 41 59;
            --c-slate-700: 51 65 85;

            /* Accents (Indigo) -> Wine Red Tones */
            --c-indigo-50: 255 241 242;
            --c-indigo-100: 255 228 230;
            --c-indigo-400: 251 113 133;
            --c-indigo-500: 244 63 94;
            --c-indigo-600: 190 18 60;  /* Rose 700 (Primary) */
            --c-indigo-700: 159 18 57;  /* Rose 800 (Hover) */
        }

        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-slideUp { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-active { overflow: hidden; }
    </style>
</head>
<body class="min-h-screen bg-slate-50 dark:bg-slate-900 transition-colors duration-300">

    <!-- Tela de Login -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center bg-slate-900 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-md p-8 md:p-10 text-center animate-slideUp">
            <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl">üîê</div>
            <h2 id="auth-title" class="text-2xl font-bold text-slate-800 dark:text-white mb-2">Acessar Conta</h2>
            <p id="auth-desc" class="text-slate-500 mb-8">Entre com seu apelido e senha.</p>
            
            <form onsubmit="handleAuth(event)" class="space-y-4">
                <input type="text" id="auth-nickname" class="w-full px-5 py-4 rounded-2xl border-2 border-slate-100 focus:border-indigo-500 outline-none text-slate-800 font-bold text-center text-lg uppercase" placeholder="SEU APELIDO" required oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '')">
                
                <input type="password" id="auth-password" class="w-full px-5 py-4 rounded-2xl border-2 border-slate-100 focus:border-indigo-500 outline-none text-slate-800 font-bold text-center text-lg tracking-widest" placeholder="SENHA" required>
                
                <button type="submit" id="auth-btn-submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-2xl transition-all shadow-lg shadow-indigo-200">Entrar</button>
            </form>

            <div class="mt-6 pt-6 border-t border-slate-100 dark:border-slate-700">
                <button onclick="toggleAuthMode()" id="auth-btn-toggle" class="text-indigo-500 font-bold hover:text-indigo-700 transition-colors text-sm">N√£o tem conta? Cadastre-se</button>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden flex flex-col md:flex-row min-h-screen">
        <!-- Sidebar -->
        <aside class="w-full md:w-64 bg-slate-900 text-white flex flex-col sticky top-0 md:h-screen z-20">
            <div class="p-6">
                <h1 class="text-2xl font-bold tracking-tight flex items-center gap-2">
                    <span class="text-indigo-400">Cont√°bil</span>App
                </h1>
            </div>
            
            <nav class="flex-1 px-4 space-y-1">
                <button onclick="switchView('dashboard')" id="btn-dashboard" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-indigo-600 text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
                    Dashboard
                </button>
                <button onclick="switchView('list')" id="btn-list" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                    Mensalidades
                </button>
                <button onclick="switchView('form')" id="btn-form" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                    Novo Lan√ßamento
                </button>
                
                <div class="pt-4 mt-4 border-t border-slate-800">
                    <button onclick="toggleModal('export-modal', true)" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-400 hover:bg-emerald-900/30 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Exportar Dados
                    </button>
                    <button onclick="toggleModal('email-modal', true)" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-purple-400 hover:bg-purple-900/30 transition-colors mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                        Enviar p/ Contador
                    </button>
                    <button onclick="toggleModal('backup-modal', true)" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-blue-400 hover:bg-blue-900/30 transition-colors mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/></svg>
                        Backup / Restaurar
                    </button>
                    <button onclick="toggleTheme()" id="theme-btn" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 transition-colors mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                        Modo Escuro
                    </button>
                    <button id="install-btn" onclick="installApp()" class="hidden w-full flex items-center gap-3 px-4 py-3 rounded-lg text-teal-400 hover:bg-teal-900/30 transition-colors mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Instalar App
                    </button>
                    <button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-rose-400 hover:bg-rose-900/30 transition-colors mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        Sair
                    </button>
                </div>
            </nav>

            <div class="p-4 border-t border-slate-800 text-xs text-slate-500 text-center uppercase tracking-widest font-bold">
                Vers√£o 3.0 (Pure JS)
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-screen overflow-hidden">
            <header class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-6 py-4 flex flex-col sm:flex-row sm:items-center justify-between gap-4 sticky top-0 z-10 transition-colors">
                <div>
                    <h2 class="text-xl font-semibold text-slate-800 dark:text-white" id="header-title">Dashboard</h2>
                    <p class="text-sm text-slate-500">Gest√£o cont√°bil simples e organizada</p>
                </div>

                <div class="flex flex-col sm:flex-row gap-3">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="Buscar..." oninput="handleSearch()" class="pl-10 pr-4 py-2 bg-slate-100 dark:bg-slate-700 dark:text-white border-none rounded-lg focus:ring-2 focus:ring-indigo-500 w-full sm:w-64">
                        <svg class="absolute left-3 top-2.5 text-slate-400" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    </div>
                    <select id="category-filter" onchange="applyFilters()" class="px-4 py-2 bg-slate-100 dark:bg-slate-700 dark:text-white border-none rounded-lg focus:ring-2 focus:ring-indigo-500 text-slate-700">
                        <option value="all">Todas Categorias</option>
                        <option value="Habita√ß√£o">Habita√ß√£o</option>
                        <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
                        <option value="Transporte">Transporte</option>
                        <option value="Contas Fixas">Contas Fixas</option>
                        <option value="Lazer">Lazer</option>
                        <option value="Sa√∫de">Sa√∫de</option>
                        <option value="Educa√ß√£o">Educa√ß√£o</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
            </header>
            
            <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 no-scrollbar">
                <!-- Conte√∫do carregado dinamicamente -->
            </div>
        </main>
    </div>

    <!-- Modal Exportar XML -->
    <div id="export-modal" class="hidden fixed inset-0 bg-slate-900/80 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 animate-slideUp">
            <h3 class="text-xl font-bold text-slate-800 mb-2">Exportar Dados</h3>
            <p class="text-slate-500 text-sm mb-6">Selecione o formato e o per√≠odo.</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Formato</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="export-format" value="xml" checked class="w-4 h-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <span class="text-sm text-slate-700 font-medium">XML</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="export-format" value="csv" class="w-4 h-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <span class="text-sm text-slate-700 font-medium">CSV (Excel)</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Data In√≠cio</label>
                    <input type="date" id="export-start" class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Data Fim</label>
                    <input type="date" id="export-end" class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="handleExport()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-all">Baixar Arquivo</button>
                <button onclick="toggleModal('export-modal', false)" class="px-6 py-3 border border-slate-200 rounded-xl text-slate-600">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Enviar Email -->
    <div id="email-modal" class="hidden fixed inset-0 bg-slate-900/80 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 animate-slideUp">
            <h3 class="text-xl font-bold text-slate-800 mb-2">Enviar para Contador</h3>
            <p class="text-slate-500 text-sm mb-6">Gera o XML e abre seu cliente de e-mail.</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Email do Contador</label>
                    <input type="email" id="accountant-email" class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-indigo-500" placeholder="contador@exemplo.com">
                    <div class="flex items-center gap-2 mt-2">
                        <input type="checkbox" id="save-email-check" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500 border-gray-300">
                        <label for="save-email-check" class="text-xs font-bold text-slate-400 uppercase cursor-pointer">Lembrar este e-mail</label>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Data In√≠cio</label>
                        <input type="date" id="email-start" class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Data Fim</label>
                        <input type="date" id="email-end" class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="handleEmailSend()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-xl transition-all">Gerar e Enviar</button>
                <button onclick="toggleModal('email-modal', false)" class="px-6 py-3 border border-slate-200 rounded-xl text-slate-600">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Backup -->
    <div id="backup-modal" class="hidden fixed inset-0 bg-slate-900/80 z-50 flex items-center justify-center p-4" onclick="if(event.target === this) toggleModal('backup-modal', false)">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 animate-slideUp">
            <h3 class="text-xl font-bold text-slate-800 mb-2">Backup e Restaura√ß√£o</h3>
            <p class="text-slate-500 text-sm mb-6">Salve seus dados ou restaure de um arquivo JSON.</p>
            
            <div class="space-y-4">
                <button onclick="downloadBackup()" class="w-full flex items-center justify-center gap-3 p-4 rounded-xl border-2 border-slate-100 hover:border-indigo-500 hover:bg-indigo-50 text-slate-700 font-bold transition-all group">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-400 group-hover:text-indigo-600"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    <span>Baixar Backup (JSON)</span>
                </button>

                <div class="relative">
                    <input type="file" id="restore-file" accept=".json" class="hidden" onchange="restoreBackup(this)">
                    <button onclick="document.getElementById('restore-file').click()" class="w-full flex items-center justify-center gap-3 p-4 rounded-xl border-2 border-slate-100 hover:border-emerald-500 hover:bg-emerald-50 text-slate-700 font-bold transition-all group">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-emerald-400 group-hover:text-emerald-600"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        <span>Restaurar Arquivo</span>
                    </button>
                </div>
            </div>

            <div class="mt-6 text-center">
                <button onclick="toggleModal('backup-modal', false)" class="text-slate-400 hover:text-slate-600 text-sm font-bold">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Pagamento -->
    <div id="payment-modal" class="hidden fixed inset-0 bg-slate-900/80 z-[60] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-md p-6 animate-slideUp">
            <div class="flex items-center gap-4 mb-6">
                <div class="w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-2xl">üí∏</div>
                <div>
                    <h3 class="text-xl font-bold text-slate-800 dark:text-white">Confirmar Pagamento</h3>
                    <p class="text-sm text-slate-500" id="pay-modal-title">Conta...</p>
                </div>
            </div>
            
            <form onsubmit="confirmPayment(event)" class="space-y-4">
                <input type="hidden" id="pay-id">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Valor Pago (R$)</label>
                    <input type="text" id="pay-amount" oninput="formatCurrency(this)" class="w-full px-4 py-3 rounded-xl border-2 border-slate-100 dark:border-slate-600 dark:bg-slate-700 dark:text-white font-bold text-lg text-slate-700 focus:border-emerald-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Anota√ß√µes (Opcional)</label>
                    <textarea id="pay-notes" rows="2" class="w-full px-4 py-3 rounded-xl border-2 border-slate-100 dark:border-slate-600 dark:bg-slate-700 dark:text-white text-sm focus:border-emerald-500 outline-none resize-none" placeholder="Ex: Pago via Pix..."></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Anexar Comprovante (Img/PDF)</label>
                    <input type="file" id="pay-file" accept="image/*,application/pdf" multiple class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100 transition-all">
                </div>

                <div class="flex gap-3 mt-6">
                    <button type="submit" class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 rounded-xl transition-all shadow-lg shadow-emerald-200 dark:shadow-none">Confirmar Pagamento</button>
                    <button type="button" onclick="toggleModal('payment-modal', false)" class="px-6 py-3 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-600 dark:text-slate-400 font-bold">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detalhes -->
    <div id="details-modal" class="hidden fixed inset-0 bg-slate-900/80 z-50 flex items-center justify-center p-4" onclick="if(event.target === this) toggleModal('details-modal', false)">
        <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-2xl p-6 md:p-8 animate-slideUp relative overflow-y-auto max-h-[90vh] no-scrollbar">
            <button onclick="toggleModal('details-modal', false)" class="absolute top-6 right-6 p-2 bg-slate-50 text-slate-400 rounded-full hover:bg-slate-100 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
            <div id="details-content" class="space-y-6">
                <!-- Conte√∫do injetado via JS -->
            </div>
        </div>
    </div>

    <!-- Modal Detalhes do Hist√≥rico -->
    <div id="history-modal" class="hidden fixed inset-0 bg-slate-900/80 z-[60] flex items-center justify-center p-4" onclick="if(event.target === this) toggleModal('history-modal', false)">
        <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-md p-6 animate-slideUp relative">
            <button onclick="toggleModal('history-modal', false)" class="absolute top-4 right-4 p-2 bg-slate-50 dark:bg-slate-700 text-slate-400 rounded-full hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-xl">üìú</div>
                <h3 class="text-xl font-bold text-slate-800 dark:text-white">Detalhes do Pagamento</h3>
            </div>
            
            <div id="history-content" class="space-y-4">
                <!-- Conte√∫do injetado via JS -->
            </div>
        </div>
    </div>

    <!-- Modal Galeria Imagens -->
    <div id="gallery-modal" class="hidden fixed inset-0 bg-slate-900/95 z-[100] flex items-center justify-center p-4" onclick="toggleModal('gallery-modal', false)">
        <div class="relative max-w-4xl w-full flex flex-col items-center" onclick="event.stopPropagation()">
            <div class="absolute -top-12 right-0 flex gap-4">
                <button onclick="downloadCurrentImage()" class="text-white hover:text-indigo-400 transition-colors" title="Baixar Imagem">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                </button>
                <button onclick="toggleModal('gallery-modal', false)" class="text-white hover:text-red-400 transition-colors" title="Fechar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>
            <div class="bg-white p-2 rounded-3xl shadow-2xl overflow-hidden mb-6 flex items-center justify-center bg-slate-900">
                <img id="gallery-img" src="" alt="Comprovante Full" class="max-h-[70vh] w-auto object-contain rounded-2xl">
            </div>
            <div id="gallery-thumbs" class="flex gap-3 px-4 py-2 bg-slate-800/90 rounded-2xl"></div>
        </div>
    </div>

    <!-- Firebase Integration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
        import { getDatabase, ref, set, onValue, remove, update, get, child } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBr1A7LaeWb0r6S2OeaMm65JY4a5rYGNIo",
            authDomain: "site-contabil-7396e.firebaseapp.com",
            databaseURL: "https://site-contabil-7396e-default-rtdb.firebaseio.com",
            projectId: "site-contabil-7396e",
            storageBucket: "site-contabil-7396e.firebasestorage.app",
            messagingSenderId: "560732345394",
            appId: "1:560732345394:web:a503e990841e228517982b",
            measurementId: "G-B26N7LGHSY"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getDatabase(app);

        // Initialize App Logic with Firebase
        if (window.initAppWithFirebase) {
            window.initAppWithFirebase({ db, ref, set, onValue, remove, update, get, child });
        }
    </script>

    <script>
        // --- ESTADO GLOBAL ---
        let expenses = [];
        let currentUser = null;
        let firebaseApi = null;
        let currentView = 'dashboard';
        let uploadedImages = [];
        let dashboardDate = new Date().toISOString().slice(0, 7);
        let dashboardMode = 'monthly'; // 'monthly' | 'custom'
        let dashboardCustomStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
        let dashboardCustomEnd = new Date().toISOString().split('T')[0];
        let dashboardCharts = {};
        let deferredPrompt;
        let searchTimeout;

        // --- FIREBASE BRIDGE ---
        window.initAppWithFirebase = (api) => {
            firebaseApi = api;
            // Se j√° tiver usu√°rio logado (recuperado do localStorage), inicia a sincroniza√ß√£o
            if (currentUser) startDataSync();
        };

        function startDataSync() {
            if (!firebaseApi || !currentUser) return;
            const { db, ref, onValue, set } = firebaseApi;
            
            onValue(ref(db, 'expenses/' + currentUser), (snapshot) => {
                const val = snapshot.val();
                if (val) {
                    // Convert Object Map to Array and Sort by ID (Timestamp) descending
                    expenses = Object.values(val).sort((a, b) => (Number(b.id) || 0) - (Number(a.id) || 0));
                } else {
                    // Migration: Upload LocalStorage if DB is empty
                    const localData = localStorage.getItem('finances_data');
                    if (localData) {
                        try {
                            const parsed = JSON.parse(localData);
                            if (Array.isArray(parsed) && parsed.length > 0) {
                                const updates = {};
                                parsed.forEach(p => updates[p.id] = p);
                                set(ref(db, 'expenses/' + currentUser), updates);
                                localStorage.removeItem('finances_data'); // Clear local after sync
                            }
                        } catch(e) { console.error("Migration error", e); }
                    }
                    expenses = [];
                }
                renderView();
            });
        };

        const suggestedCategories = ['Habita√ß√£o', 'Alimenta√ß√£o', 'Transporte', 'Contas Fixas', 'Lazer', 'Sa√∫de', 'Educa√ß√£o', 'Outros'];

        // --- AUTH ---
        let isRegisterMode = false;

        function initAuth() {
            const storedUser = localStorage.getItem('app_user');
            
            // Limpeza de seguran√ßa para evitar conflito com vers√£o antiga
            sessionStorage.removeItem('app_session');

            if (storedUser) {
                currentUser = storedUser;
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                loadApp();
                if (firebaseApi) startDataSync();
            }
        }

        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            const title = document.getElementById('auth-title');
            const btn = document.getElementById('auth-btn-submit');
            const toggle = document.getElementById('auth-btn-toggle');
            
            if (isRegisterMode) {
                title.innerText = "Criar Nova Conta";
                btn.innerText = "Cadastrar";
                toggle.innerText = "J√° tem conta? Entrar";
            } else {
                title.innerText = "Acessar Conta";
                btn.innerText = "Entrar";
                toggle.innerText = "N√£o tem conta? Cadastre-se";
            }
        }

        async function handleAuth(e) {
            e.preventDefault();
            if (!firebaseApi) return alert("Conectando ao servidor... Tente novamente em instantes.");

            const nickname = document.getElementById('auth-nickname').value.trim();
            const password = document.getElementById('auth-password').value;
            const { db, ref, get, child, set } = firebaseApi;

            if (nickname.length < 3) return alert("O apelido deve ter pelo menos 3 letras.");
            if (password.length < 4) return alert("A senha deve ter pelo menos 4 caracteres.");

            const dbRef = ref(db);
            
            if (isRegisterMode) {
                // CADASTRAR
                const snapshot = await get(child(dbRef, `users/${nickname}`));
                if (snapshot.exists()) {
                    alert("Este apelido j√° est√° em uso. Escolha outro.");
                } else {
                    await set(ref(db, `users/${nickname}`), { password: password });
                    loginSuccess(nickname);
                }
            } else {
                // LOGIN
                const snapshot = await get(child(dbRef, `users/${nickname}`));
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    if (userData.password === password) {
                        loginSuccess(nickname);
                    } else {
                        alert("Senha incorreta.");
                    }
                } else {
                    alert("Usu√°rio n√£o encontrado. Verifique o apelido ou cadastre-se.");
                }
            }
        }

        function loginSuccess(nickname) {
            currentUser = nickname;
            localStorage.setItem('app_user', nickname);
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            loadApp();
            startDataSync();
        }

        function logout() {
            localStorage.removeItem('app_user');
            sessionStorage.removeItem('app_session'); // Garante limpeza da vers√£o antiga
            location.reload();
        }

        // --- INICIALIZA√á√ÉO ---
        window.onload = () => {
            initAuth();
            initTheme();
            registerSW();
        };

        function loadApp() {
            document.getElementById('export-start').value = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
            document.getElementById('export-end').value = new Date().toISOString().split('T')[0];
            document.getElementById('email-start').value = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
            document.getElementById('email-end').value = new Date().toISOString().split('T')[0];
            
            const savedEmail = localStorage.getItem('accountant_email');
            if (savedEmail) {
                document.getElementById('accountant-email').value = savedEmail;
                document.getElementById('save-email-check').checked = true;
            }
            switchView('dashboard');
        }

        function registerSW() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then(() => console.log('Service Worker registrado!'))
                    .catch(err => console.error('Falha no SW:', err));
            }
        }

        // --- PWA INSTALL ---
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btn = document.getElementById('install-btn');
            if(btn) btn.classList.remove('hidden');
        });

        async function installApp() {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                deferredPrompt = null;
                document.getElementById('install-btn').classList.add('hidden');
            }
        }

        // --- TEMA ---
        const themes = ['light', 'salvati', 'marinho'];

        function toggleTheme() {
            const current = localStorage.getItem('theme') || 'light';
            const nextIndex = (themes.indexOf(current) + 1) % themes.length;
            const nextTheme = themes[nextIndex];
            setTheme(nextTheme);
        }

        function setTheme(theme) {
            const root = document.documentElement;
            root.classList.remove('dark', 'theme-salvati', 'theme-marinho');
            
            if (theme !== 'light') {
                root.classList.add('dark'); // All non-light themes use dark layout
                if (theme === 'salvati') root.classList.add('theme-salvati');
                if (theme === 'marinho') root.classList.add('theme-marinho');
            }
            
            localStorage.setItem('theme', theme);
            updateThemeBtn(theme);
        }

        function initTheme() {
            const saved = localStorage.getItem('theme');
            const theme = saved || 'light';
            setTheme(theme);
        }

        function updateThemeBtn(theme) {
            const btn = document.getElementById('theme-btn');
            if(btn) {
                let label = 'Modo Claro';
                let icon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>`;
                
                if (theme === 'salvati') {
                    label = 'Modo Salvati';
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>`;
                } else if (theme === 'marinho') {
                    label = 'Modo Marinho';
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path></svg>`;
                }
                
                btn.innerHTML = `${icon} ${label}`;
            }
        }

        // --- NAVEGA√á√ÉO ---
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('text-slate-400', 'hover:bg-slate-800');
            });
            document.getElementById(`btn-${view}`).classList.remove('text-slate-400', 'hover:bg-slate-800');
            document.getElementById(`btn-${view}`).classList.add('bg-indigo-600', 'text-white');
            
            document.getElementById('header-title').innerText = 
                view === 'dashboard' ? 'Dashboard' : 
                view === 'list' ? 'Mensalidades' : 'Novo Lan√ßamento';

            renderView();
        }

        function toggleModal(id, show) {
            const modal = document.getElementById(id);
            modal.classList.toggle('hidden', !show);
            document.body.classList.toggle('modal-active', show);
        }

        // --- RENDERS ---
        function renderView() {
            const container = document.getElementById('content-area');
            updateCategoryFilter(); // Atualiza o filtro com categorias existentes
            if (currentView === 'dashboard') renderDashboard(container);
            else if (currentView === 'list') renderList(container);
            else if (currentView === 'form') renderForm(container);
        }

        function updateCategoryFilter() {
            const filter = document.getElementById('category-filter');
            const currentVal = filter.value;
            const uniqueCats = [...new Set(expenses.map(e => e.category))].sort();
            
            filter.innerHTML = `<option value="all">Todas Categorias</option>` + 
                uniqueCats.map(c => `<option value="${c}">${c}</option>`).join('');
            
            if (uniqueCats.includes(currentVal) || currentVal === 'all') {
                filter.value = currentVal;
            }
        }

        function renderDashboard(container) {
            // Setup Month Options (always needed for dropdown)
            const allMonths = [...new Set(expenses.map(e => e.date.slice(0, 7)))].sort().reverse();
            const currentRealMonth = new Date().toISOString().slice(0, 7);
            const monthOptions = [...new Set([...allMonths, currentRealMonth])].sort().reverse();
            
            if (!monthOptions.includes(dashboardDate)) dashboardDate = monthOptions[0];

            // Determine Data based on Mode
            let currentData, prevData;
            
            if (dashboardMode === 'monthly') {
                currentData = expenses.filter(e => e.date.startsWith(dashboardDate));
                
                const [y, m] = dashboardDate.split('-');
                const prevDate = new Date(y, m - 2, 1).toISOString().slice(0, 7);
                prevData = expenses.filter(e => e.date.startsWith(prevDate));
            } else {
                // Custom Mode
                currentData = expenses.filter(e => e.date >= dashboardCustomStart && e.date <= dashboardCustomEnd);
                
                // Compare with previous period of same length
                const start = new Date(dashboardCustomStart);
                const end = new Date(dashboardCustomEnd);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 
                
                const prevEnd = new Date(start);
                prevEnd.setDate(prevEnd.getDate() - 1);
                const prevStart = new Date(prevEnd);
                prevStart.setDate(prevStart.getDate() - diffDays + 1);
                
                const pStartStr = prevStart.toISOString().split('T')[0];
                const pEndStr = prevEnd.toISOString().split('T')[0];
                
                prevData = expenses.filter(e => e.date >= pStartStr && e.date <= pEndStr);
            }

            // M√©tricas
            const total = currentData.reduce((acc, cur) => acc + parseFloat(cur.amount), 0);
            const prevTotal = prevData.reduce((acc, cur) => acc + parseFloat(cur.amount), 0);
            const totalDiff = prevTotal > 0 ? ((total - prevTotal) / prevTotal) * 100 : 0;

            const count = currentData.length;
            const prevCount = prevData.length;
            const countDiff = prevCount > 0 ? ((count - prevCount) / prevCount) * 100 : 0;

            const avg = count > 0 ? (total / count) : 0;
            const maxVal = currentData.length > 0 ? Math.max(...currentData.map(e => parseFloat(e.amount))) : 0;
            const recent = currentData.slice(0, 6);

            // Badge Helper
            const getBadge = (diff, inverse = false) => {
                if (prevTotal === 0 && diff === 0) return '<span class="text-[10px] text-slate-400 bg-slate-100 px-2 py-1 rounded-full">Sem hist√≥rico</span>';
                const isUp = diff > 0;
                // Para gastos: Subir √© "ruim" (Rose), Descer √© "bom" (Emerald). Inverse inverte isso.
                const color = inverse ? (isUp ? 'text-emerald-600 bg-emerald-50' : 'text-rose-600 bg-rose-50') : (isUp ? 'text-rose-600 bg-rose-50' : 'text-emerald-600 bg-emerald-50');
                const icon = isUp ? '‚Üë' : '‚Üì';
                return `<span class="${color} text-[10px] font-bold px-2 py-1 rounded-full flex items-center gap-1">${icon} ${Math.abs(diff).toFixed(0)}%</span>`;
            };

            container.innerHTML = `
                <div class="space-y-6 animate-slideUp">
                    <!-- Header & Filter -->
                    <div class="flex flex-col xl:flex-row xl:items-center justify-between gap-4">
                        <h3 class="text-lg font-bold text-slate-800 dark:text-white">Vis√£o Geral</h3>
                        
                        <div class="flex flex-col sm:flex-row gap-3 bg-white dark:bg-slate-800 p-1.5 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                            <!-- Mode Toggles -->
                            <div class="flex bg-slate-100 dark:bg-slate-700 rounded-lg p-1 self-start sm:self-center">
                                <button onclick="setDashboardMode('monthly')" class="${dashboardMode === 'monthly' ? 'bg-white dark:bg-slate-600 shadow-sm text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700'} px-3 py-1.5 rounded-md text-xs font-bold transition-all">Mensal</button>
                                <button onclick="setDashboardMode('custom')" class="${dashboardMode === 'custom' ? 'bg-white dark:bg-slate-600 shadow-sm text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700'} px-3 py-1.5 rounded-md text-xs font-bold transition-all">Personalizado</button>
                            </div>

                            <!-- Controls -->
                            <div class="flex items-center gap-2">
                                ${dashboardMode === 'monthly' ? `
                                    <select onchange="updateDashboardDate(this.value)" class="bg-transparent dark:text-white text-slate-700 text-sm font-bold focus:ring-0 border-none outline-none cursor-pointer py-1 pl-2 pr-8">
                                        ${monthOptions.map(opt => {
                                            const [yr, mo] = opt.split('-');
                                            const label = new Date(yr, mo-1, 1).toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
                                            return `<option value="${opt}" ${opt === dashboardDate ? 'selected' : ''}>${label.charAt(0).toUpperCase() + label.slice(1)}</option>`;
                                        }).join('')}
                                    </select>
                                ` : `
                                    <div class="flex items-center gap-2 px-2">
                                        <input type="date" value="${dashboardCustomStart}" onchange="updateCustomDates('start', this.value)" class="bg-slate-50 dark:bg-slate-600 border-none rounded-lg text-xs font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 py-1.5 px-2">
                                        <span class="text-slate-400 font-bold">-</span>
                                        <input type="date" value="${dashboardCustomEnd}" onchange="updateCustomDates('end', this.value)" class="bg-slate-50 dark:bg-slate-600 border-none rounded-lg text-xs font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 py-1.5 px-2">
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>

                    <!-- Cards Topo -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col justify-between gap-4">
                            <div class="flex justify-between items-start">
                                <div class="p-3 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-xl">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                                </div>
                                ${getBadge(totalDiff)}
                            </div>
                            <div>
                                <p class="text-slate-500 text-xs font-bold uppercase tracking-wider">Total ${dashboardMode === 'monthly' ? 'Mensal' : 'Per√≠odo'}</p>
                                <p class="text-2xl font-bold text-slate-800 dark:text-white">R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col justify-between gap-4">
                            <div class="flex justify-between items-start">
                                <div class="p-3 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded-xl">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                                </div>
                                ${getBadge(countDiff, true)}
                            </div>
                            <div>
                                <p class="text-slate-500 text-xs font-bold uppercase tracking-wider">Lan√ßamentos</p>
                                <p class="text-2xl font-bold text-slate-800 dark:text-white">${count}</p>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col justify-between gap-4">
                            <div class="flex justify-between items-start">
                                <div class="p-3 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-xl">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>
                                </div>
                            </div>
                            <div>
                                <p class="text-slate-500 text-xs font-bold uppercase tracking-wider">M√©dia Di√°ria</p>
                                <p class="text-2xl font-bold text-slate-800 dark:text-white">R$ ${avg.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col justify-between gap-4">
                            <div class="flex justify-between items-start">
                                <div class="p-3 bg-rose-50 dark:bg-rose-900/30 text-rose-600 dark:text-rose-400 rounded-xl">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                </div>
                            </div>
                            <div>
                                <p class="text-slate-500 text-xs font-bold uppercase tracking-wider">Maior Gasto</p>
                                <p class="text-2xl font-bold text-slate-800 dark:text-white">R$ ${maxVal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Gr√°fico Barras -->
                        <div class="lg:col-span-2 bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-6 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
                                An√°lise por Categoria
                            </h3>
                            <div class="flex-1 min-h-[300px] relative">
                                <canvas id="categoryChart"></canvas>
                            </div>
                        </div>

                        <!-- Gr√°fico Pizza (Novo) -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-6 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-500"><circle cx="12" cy="12" r="10"/><path d="M16.2 7.8l-2 6.3-6.4 2.1 2-6.3z"/></svg>
                                Distribui√ß√£o
                            </h3>
                            <div class="flex-1 min-h-[200px] relative flex items-center justify-center">
                                <canvas id="distributionChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- √öltimos Registros (Full Width) -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-emerald-500"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                                √öltimos Registros ${dashboardMode === 'monthly' ? 'do M√™s' : 'do Per√≠odo'}
                            </h3>
                            <button onclick="switchView('list')" class="text-sm font-bold text-indigo-600 dark:text-indigo-400 hover:text-indigo-700 transition-colors">Ver Todos</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${recent.length ? recent.map(e => `
                                <div class="flex items-center gap-3 p-4 bg-slate-50 dark:bg-slate-700/50 rounded-xl border border-slate-100 dark:border-slate-600">
                                    <div class="w-10 h-10 rounded-lg bg-white shadow-sm flex items-center justify-center text-lg">
                                        ${getIcon(e.category)}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-bold text-slate-700 dark:text-slate-200 truncate">${e.title}</p>
                                        <p class="text-xs text-slate-400">${e.date.split('-').reverse().join('/')}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-bold text-indigo-600">R$ ${parseFloat(e.amount).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                                    </div>
                                </div>
                            `).join('') : '<p class="col-span-full text-slate-400 text-sm text-center py-4">Nenhum registro neste per√≠odo.</p>'}
                        </div>
                    </div>
                </div>
            `;
            initDashboardCharts(currentData);
        }

        function renderForm(container) {
            uploadedImages = [];
            container.innerHTML = `
                <div class="max-w-6xl mx-auto bg-white dark:bg-slate-800 rounded-3xl shadow-xl p-8 md:p-12 animate-slideUp">
                    <h2 class="text-3xl font-bold text-slate-800 dark:text-white mb-10">Novo Lan√ßamento</h2>
                    <form onsubmit="saveExpense(event)" class="space-y-8">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                            <!-- Coluna Principal (Inputs) -->
                            <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="space-y-2">
                                    <label class="text-sm font-bold text-slate-400 uppercase tracking-wider">Descri√ß√£o</label>
                                    <input type="text" id="form-title" required class="w-full px-5 py-4 rounded-2xl border-2 border-slate-100 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:border-indigo-500 outline-none text-slate-800 font-medium text-lg" placeholder="Ex: Aluguel">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-sm font-bold text-slate-400 uppercase tracking-wider">Valor (R$)</label>
                                    <input type="text" id="form-amount" oninput="formatCurrency(this)" required class="w-full px-5 py-4 rounded-2xl border-2 border-slate-100 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:border-indigo-500 outline-none text-slate-800 font-medium text-lg" placeholder="0,00">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-sm font-bold text-slate-400 uppercase tracking-wider">Data</label>
                                    <input type="date" id="form-date" required class="w-full px-5 py-4 rounded-2xl border-2 border-slate-100 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:border-indigo-500 outline-none text-slate-800 font-medium text-lg">
                                </div>
                                <div class="space-y-2 relative">
                                    <label class="text-sm font-bold text-slate-400 uppercase tracking-wider">Categoria</label>
                                    <div class="relative">
                                        <input type="text" id="form-category" readonly 
                                            onclick="toggleCategoryList()"
                                            oninput="this.value = this.value.toUpperCase()"
                                            required 
                                            class="w-full px-5 py-4 rounded-2xl border-2 border-slate-100 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:border-indigo-500 outline-none text-slate-800 font-bold uppercase cursor-pointer placeholder-slate-400 text-lg" 
                                            placeholder="SELECIONE A CATEGORIA">
                                        <div onclick="toggleCategoryList()" class="absolute right-5 top-1/2 -translate-y-1/2 text-slate-400 cursor-pointer hover:text-indigo-500 transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                                        </div>
                                    </div>
                                    
                                    <!-- Dropdown Customizado -->
                                    <div id="category-dropdown" class="hidden absolute z-20 w-full mt-2 bg-slate-900 rounded-2xl shadow-xl overflow-hidden border border-slate-700 animate-slideUp">
                                        <div class="max-h-60 overflow-y-auto no-scrollbar">
                                            ${suggestedCategories.filter(c => c !== 'Outros').map(c => `
                                                <div onclick="selectCategory('${c.toUpperCase()}')" class="px-5 py-4 text-white font-bold text-base hover:bg-indigo-600 cursor-pointer transition-colors border-b border-slate-800 last:border-0 flex items-center gap-3">
                                                    <span>${getIcon(c)}</span>
                                                    ${c.toUpperCase()}
                                                </div>
                                            `).join('')}
                                            <div onclick="enableCustomCategory()" class="px-5 py-4 text-indigo-400 font-bold text-base hover:bg-slate-800 cursor-pointer transition-colors flex items-center gap-3 border-t border-slate-700">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                                                OUTRO...
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-sm font-bold text-slate-400 uppercase tracking-wider">Recorr√™ncia</label>
                                    <select id="form-recurrence" onchange="handleRecurrenceChange()" class="w-full px-5 py-4 rounded-2xl border-2 border-slate-100 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:border-indigo-500 outline-none text-slate-800 font-medium bg-white text-lg">
                                        <option value="unica">√önica</option>
                                        <option value="mensal">Mensal</option>
                                        <option value="bimestral">Bimestral</option>
                                        <option value="trimestral">Trimestral</option>
                                        <option value="semestral">Semestral</option>
                                    </select>
                                </div>
                                <div class="space-y-2 hidden" id="div-due-day">
                                    <label class="text-sm font-bold text-slate-400 uppercase tracking-wider">Dia de Vencimento</label>
                                    <input type="number" id="form-due-day" min="1" max="31" class="w-full px-5 py-4 rounded-2xl border-2 border-slate-100 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:border-indigo-500 outline-none text-slate-800 font-medium text-lg" placeholder="Dia (1-31)">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-sm font-bold text-slate-400 uppercase tracking-wider">Forma de Pagamento</label>
                                    <select id="form-payment" class="w-full px-5 py-4 rounded-2xl border-2 border-slate-100 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:border-indigo-500 outline-none text-slate-800 font-medium bg-white text-lg">
                                        <option value="boleto">üìÑ Boleto</option>
                                        <option value="pix">üí† Pix</option>
                                        <option value="cartao">üí≥ Cart√£o de Cr√©dito</option>
                                        <option value="debito">üí≥ D√©bito</option>
                                        <option value="dinheiro">üíµ Dinheiro</option>
                                        <option value="automatico">üîÑ D√©bito Autom√°tico</option>
                                    </select>
                                </div>
                                <div class="space-y-2 hidden" id="div-installments">
                                    <label class="text-sm font-bold text-slate-400 uppercase tracking-wider">Op√ß√µes de Parcelamento</label>
                                    <div class="flex gap-4">
                                        <select id="form-installments-type" onchange="toggleInstallmentType()" class="w-1/2 px-4 py-4 rounded-2xl border-2 border-slate-100 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:border-indigo-500 outline-none text-slate-800 font-bold text-sm bg-white">
                                            <option value="fixed">Parcelado (x Vezes)</option>
                                            <option value="subscription">Mensalidade (Fixo)</option>
                                        </select>
                                        <div class="relative w-1/2" id="div-installments-input">
                                            <input type="number" id="form-installments" min="1" value="1" class="w-full px-5 py-4 rounded-2xl border-2 border-slate-100 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:border-indigo-500 outline-none text-slate-800 font-medium text-lg" placeholder="1">
                                            <span class="absolute right-5 top-1/2 -translate-y-1/2 text-sm font-bold text-slate-400 pointer-events-none">x</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Coluna Lateral (Notas e Status) -->
                            <div class="space-y-8">
                                <div class="space-y-2">
                                    <label class="text-sm font-bold text-slate-400 uppercase tracking-wider">Anota√ß√µes</label>
                                    <textarea id="form-notes" rows="5" class="w-full px-5 py-4 rounded-2xl border-2 border-slate-100 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:border-indigo-500 outline-none text-slate-800 font-medium resize-none text-lg" placeholder="Opcional..."></textarea>
                                </div>
                                
                                <div class="flex items-center gap-4 p-5 bg-slate-50 dark:bg-slate-700/50 rounded-2xl border border-slate-100 dark:border-slate-600">
                                    <input type="checkbox" id="form-paid" class="w-6 h-6 text-indigo-600 rounded-md focus:ring-indigo-500 border-gray-300 cursor-pointer">
                                    <label for="form-paid" class="font-bold text-slate-600 dark:text-slate-300 cursor-pointer select-none">Este lan√ßamento j√° foi pago?</label>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-4 pt-6">
                            <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-5 rounded-2xl shadow-xl transition-all text-lg">Salvar Mensalidade</button>
                            <button type="button" onclick="switchView('dashboard')" class="px-8 py-5 rounded-2xl border-2 border-slate-100 dark:border-slate-600 font-bold text-slate-500 dark:text-slate-400 text-lg">Cancelar</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('form-date').value = new Date().toISOString().split('T')[0];
        }

        function renderList(container) {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const categoryFilter = document.getElementById('category-filter').value;
            const showPaid = localStorage.getItem('show_paid_items') === 'true';

            // Migra√ß√£o de dados antigos (adiciona status se n√£o existir)
            expenses = expenses.map(e => ({ ...e, status: e.status || 'pending' }));
            localStorage.setItem('finances_data', JSON.stringify(expenses));

            const filtered = expenses.filter(e => {
                const matchSearch = e.title.toLowerCase().includes(searchTerm) || (e.notes || '').toLowerCase().includes(searchTerm);
                const matchCat = categoryFilter === 'all' || e.category === categoryFilter;
                const matchStatus = showPaid ? true : e.status === 'pending';
                return matchSearch && matchCat && matchStatus;
            });

            // Defini√ß√£o de Datas para as Se√ß√µes
            const today = new Date();
            today.setHours(0,0,0,0);
            const todayStr = today.toISOString().split('T')[0];
            
            const endOfWeek = new Date(today);
            endOfWeek.setDate(today.getDate() + (6 - today.getDay())); // S√°bado
            const endOfWeekStr = endOfWeek.toISOString().split('T')[0];

            const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            const endOfMonthStr = endOfMonth.toISOString().split('T')[0];

            // Buckets
            const buckets = {
                overdue: { label: 'üö® Atrasadas', items: [], color: 'text-rose-500', border: 'border-rose-200 bg-rose-50' },
                today: { label: 'üìÖ Faturas do Dia', items: [], color: 'text-indigo-600', border: 'border-indigo-200 bg-indigo-50' },
                week: { label: 'üóìÔ∏è Faturas da Semana', items: [], color: 'text-blue-500', border: 'border-slate-100' },
                month: { label: 'üìÜ Faturas do M√™s', items: [], color: 'text-slate-600', border: 'border-slate-100' },
                future: { label: 'üîÆ Lan√ßamentos Futuros', items: [], color: 'text-slate-400', border: 'border-slate-100' },
                paid: { label: '‚úÖ Pagas / Conclu√≠das', items: [], color: 'text-emerald-600', border: 'border-emerald-100 bg-emerald-50/50 opacity-75' }
            };

            filtered.forEach(e => {
                if (e.status === 'paid') {
                    buckets.paid.items.push(e);
                } else {
                    if (e.date < todayStr) buckets.overdue.items.push(e);
                    else if (e.date === todayStr) buckets.today.items.push(e);
                    else if (e.date <= endOfWeekStr) buckets.week.items.push(e);
                    else if (e.date <= endOfMonthStr) buckets.month.items.push(e);
                    else buckets.future.items.push(e);
                }
            });

            if (filtered.length === 0) {
                container.innerHTML = `
                <div class="flex justify-end mb-4">
                    <label class="flex items-center gap-2 cursor-pointer bg-white dark:bg-slate-800 px-4 py-2 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <input type="checkbox" ${showPaid ? 'checked' : ''} onchange="toggleShowPaid(this.checked)" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500">
                        <span class="text-xs font-bold text-slate-600 dark:text-slate-300 uppercase">Mostrar Pagas</span>
                    </label>
                </div>
                <div class="bg-white dark:bg-slate-800 p-24 rounded-3xl border border-slate-100 dark:border-slate-700 flex flex-col items-center justify-center text-center shadow-sm">
                    <div class="w-24 h-24 bg-slate-50 dark:bg-slate-700 rounded-full flex items-center justify-center text-4xl mb-6 shadow-inner">üìÅ</div>
                    <h3 class="text-2xl font-bold text-slate-800 dark:text-white">Tudo em dia!</h3>
                    <p class="text-slate-500">Nenhuma conta pendente encontrada nos filtros.</p>
                </div>`;
                return;
            }

            let html = `
                <div class="flex justify-end mb-6 animate-slideUp">
                    <label class="flex items-center gap-2 cursor-pointer bg-white dark:bg-slate-800 px-4 py-2 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 hover:bg-slate-50 transition-colors">
                        <input type="checkbox" ${showPaid ? 'checked' : ''} onchange="toggleShowPaid(this.checked)" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300">
                        <span class="text-xs font-bold text-slate-600 dark:text-slate-300 uppercase">Mostrar Pagas</span>
                    </label>
                </div>
                <div class="space-y-10 pb-20">
            `;
            
            // Renderizar cada bucket
            Object.keys(buckets).forEach(key => {
                const bucket = buckets[key];
                if (bucket.items.length === 0) return;

                // Ordenar por data
                bucket.items.sort((a, b) => new Date(a.date) - new Date(b.date));

                html += `
                    <section class="space-y-4 animate-slideUp">
                        <h3 class="text-sm font-black ${bucket.color} uppercase tracking-widest px-2 flex items-center gap-3">
                            ${bucket.label} <span class="bg-slate-100 dark:bg-slate-700 text-slate-500 px-2 py-0.5 rounded-full text-[10px]">${bucket.items.length}</span> <div class="h-px flex-1 bg-slate-100 dark:bg-slate-700"></div>
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                            ${bucket.items.map(e => renderCard(e, bucket.border)).join('')}
                        </div>
                    </section>
                `;
            });

            html += '</div>';
            
            // Input file oculto global para uploads r√°pidos
            html += `<input type="file" id="card-file-input" accept="image/*,application/pdf" class="hidden" onchange="handleCardFile(this)">`;
            
            container.innerHTML = html;
        }

        function renderCard(e, borderClass) {
            const isPaid = e.status === 'paid';
            const isRecurring = e.recurrence !== 'unica';
            return `
                <div onclick="openDetails('${e.id}')" class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border ${isPaid ? 'border-emerald-200' : 'border-slate-100 dark:border-slate-700'} p-5 flex flex-col group hover:shadow-md transition-all duration-200 relative overflow-hidden ${isPaid ? 'opacity-80 grayscale-[0.3]' : ''}">
                    
                    <!-- A√ß√µes R√°pidas -->
                    <div class="absolute top-4 right-4 flex gap-2 z-10">
                        <button onclick="event.stopPropagation(); ${isPaid ? `toggleStatus('${e.id}')` : `openPaymentModal('${e.id}')`}" class="h-8 px-3 rounded-lg flex items-center gap-1.5 transition-all ${isPaid ? 'bg-emerald-500 text-white shadow-emerald-200 shadow-lg' : 'bg-white border border-slate-200 dark:bg-slate-700 dark:border-slate-600 text-slate-500 hover:border-emerald-500 hover:text-emerald-500'}" title="${isPaid ? 'Marcar como Pendente' : 'Pagar Agora'}">
                            ${isPaid ? '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>' : '<span class="text-[10px] font-bold uppercase">Pagar</span>'}
                        </button>
                        <button onclick="event.stopPropagation(); deleteExpense('${e.id}')" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-400 hover:bg-rose-500 hover:text-white flex items-center justify-center transition-all opacity-0 group-hover:opacity-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                        </button>
                    </div>

                    <div class="flex items-start gap-4 mb-4">
                        <div class="w-12 h-12 rounded-xl ${isPaid ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-50 dark:bg-slate-700 text-slate-600 dark:text-slate-300'} flex items-center justify-center text-xl border border-white dark:border-slate-600 shadow-sm">
                            ${getIcon(e.category)}
                        </div>
                        <div class="flex-1 pr-16">
                            <h4 class="font-bold text-slate-800 dark:text-white text-base line-clamp-1 ${isPaid ? 'line-through text-slate-400' : ''}">${e.title}</h4>
                            <div class="flex flex-wrap gap-2 mt-1">
                                <span class="inline-block px-1.5 py-0.5 bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 text-[10px] font-bold rounded uppercase">${e.category}</span>
                                ${e.date < new Date().toISOString().split('T')[0] && !isPaid ? '<span class="inline-block px-1.5 py-0.5 bg-rose-100 text-rose-600 text-[10px] font-bold rounded uppercase">Atrasado</span>' : ''}
                                ${e.installmentsTotal ? `<span class="inline-block px-1.5 py-0.5 bg-indigo-100 text-indigo-600 text-[10px] font-bold rounded uppercase">Parcela ${e.installmentsPaid + 1}/${e.installmentsTotal}</span>` : ''}
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between mt-2 pt-3 border-t border-slate-50 dark:border-slate-700/50">
                        <div class="flex flex-col">
                            <span class="text-[10px] font-bold text-slate-400 uppercase">Vencimento</span>
                            <span class="text-sm font-bold text-slate-700 dark:text-slate-200">${e.date.split('-').reverse().join('/')}</span>
                        </div>
                        <div class="flex flex-col items-end">
                            <span class="text-[10px] font-bold text-slate-400 uppercase">Valor</span>
                            <span class="text-lg font-black ${isPaid ? 'text-emerald-600' : 'text-indigo-600'}">R$ ${parseFloat(e.amount).toLocaleString('pt-BR', {minimumFractionDigits:2})}</span>
                        </div>
                    </div>

                    <!-- √Årea de Comprovantes -->
                    <div class="mt-3 flex items-center gap-2">
                        ${e.receiptImages && e.receiptImages.length > 0 ? `
                            <div class="flex -space-x-2 overflow-hidden py-1 px-1">
                                ${e.receiptImages.slice(0,3).map((img, idx) => `
                                    <div onclick='event.stopPropagation(); openGallery("${e.id}", ${idx})' class="w-8 h-8 rounded-full border-2 border-white dark:border-slate-800 overflow-hidden cursor-pointer hover:scale-110 transition-transform z-0 hover:z-10">
                                        ${img.startsWith('data:application/pdf') ? '<div class="w-full h-full bg-red-50 flex items-center justify-center text-[8px] text-red-500 font-bold">PDF</div>' : `<img src="${img}" class="w-full h-full object-cover">`}
                                    </div>
                                `).join('')}
                                ${e.receiptImages.length > 3 ? `<div class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 border-2 border-white dark:border-slate-800 flex items-center justify-center text-[10px] font-bold text-slate-500">+${e.receiptImages.length - 3}</div>` : ''}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // --- L√ìGICA DE DADOS ---
        function openPaymentModal(id) {
            const e = expenses.find(exp => exp.id === id);
            if (!e) return;
            
            document.getElementById('pay-id').value = id;
            document.getElementById('pay-modal-title').innerText = `${e.title} - Vencimento: ${e.date.split('-').reverse().join('/')}`;
            
            // Pre-fill amount
            const amountStr = parseFloat(e.amount).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            document.getElementById('pay-amount').value = amountStr;
            document.getElementById('pay-notes').value = e.notes || '';
            document.getElementById('pay-file').value = '';
            
            toggleModal('payment-modal', true);
        }

        async function confirmPayment(event) {
            event.preventDefault();
            const id = document.getElementById('pay-id').value;
            const amountStr = document.getElementById('pay-amount').value;
            const notes = document.getElementById('pay-notes').value;
            const fileInput = document.getElementById('pay-file');
            
            const idx = expenses.findIndex(e => e.id === id);
            if (idx > -1) {
                // Atualizar dados
                const expense = expenses[idx];
                const paidAmount = parseFloat(amountStr.replace(/\./g, '').replace(',', '.'));
                
                // Criar registro no hist√≥rico (Sub-caixa)
                const historyItem = {
                    datePaid: new Date().toISOString().split('T')[0],
                    amount: paidAmount,
                    originalDate: expense.date,
                    notes: notes,
                    receiptImages: []
                };
                
                // Processar novos arquivos
                if (fileInput.files.length > 0) {
                    for (const file of fileInput.files) {
                        const base64 = await readFileAsBase64(file);
                        historyItem.receiptImages.push(base64);
                    }
                }
                
                if (!expense.paymentHistory) expense.paymentHistory = [];
                expense.paymentHistory.push(historyItem);

                // L√≥gica de Atualiza√ß√£o (Recorr√™ncia)
                if (expense.recurrence === 'unica') {
                    expense.status = 'paid';
                    expense.amount = paidAmount;
                    expense.notes = notes;
                    if (historyItem.receiptImages.length) expense.receiptImages = historyItem.receiptImages;
                } else {
                    // Recorrente: Avan√ßa a data
                    const currentDueDay = expense.dueDay || expense.date.split('-')[2];
                    if (expense.installmentsTotal) {
                        expense.installmentsPaid = (expense.installmentsPaid || 0) + 1;
                        if (expense.installmentsPaid >= expense.installmentsTotal) expense.status = 'paid';
                        else expense.date = calculateNextDue(expense.date, expense.recurrence, currentDueDay);
                    } else {
                        expense.date = calculateNextDue(expense.date, expense.recurrence, currentDueDay);
                    }
                }

                if (firebaseApi) {
                    const { db, ref, update } = firebaseApi;
                    update(ref(db, `expenses/${currentUser}/${id}`), expense);
                }
                toggleModal('payment-modal', false);
                
                // Se estiver na lista, atualiza. Se estiver no dashboard, atualiza.
                renderView();
            }
        }

        function toggleShowPaid(checked) {
            localStorage.setItem('show_paid_items', checked);
            renderList(document.getElementById('content-area'));
        }

        function toggleStatus(id) {
            const idx = expenses.findIndex(e => e.id === id);
            if (idx > -1) {
                // Se for recorrente, for√ßa abrir o modal para confirmar pagamento e avan√ßar data
                if (expenses[idx].recurrence !== 'unica' && expenses[idx].status !== 'paid') {
                    openPaymentModal(id);
                    return;
                }
                const newStatus = expenses[idx].status === 'paid' ? 'pending' : 'paid';
                expenses[idx].status = newStatus;
                
                // Se marcou como pago e tem recorr√™ncia, poderia sugerir criar o pr√≥ximo (feature futura)
                
                if (firebaseApi) {
                    const { db, ref, update } = firebaseApi;
                    update(ref(db, `expenses/${currentUser}/${id}`), { status: newStatus });
                }
                renderList(document.getElementById('content-area'));
            }
        }

        let currentUploadId = null;
        function triggerCardUpload(id) {
            currentUploadId = id;
            document.getElementById('card-file-input').click();
        }

        function handleCardFile(input) {
            if (input.files && input.files[0] && currentUploadId) {
                const file = input.files[0];
                processFile(file).then(base64 => {
                    const idx = expenses.findIndex(exp => exp.id === currentUploadId);
                    if (idx > -1) {
                        if (!expenses[idx].receiptImages) expenses[idx].receiptImages = [];
                        expenses[idx].receiptImages.push(base64);
                        if (firebaseApi) {
                            const { db, ref, update } = firebaseApi;
                            update(ref(db, `expenses/${currentUser}/${currentUploadId}`), { receiptImages: expenses[idx].receiptImages });
                        }
                        renderList(document.getElementById('content-area'));
                    }
                    currentUploadId = null;
                    input.value = '';
                });
            }
        }

        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function processFile(file) {
            if (file.type === 'application/pdf') {
                return await readFileAsBase64(file);
            } else {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width; let height = img.height;
                            const MAX_SIZE = 800;
                            if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } }
                            else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } }
                            canvas.width = width; canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', 0.7));
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        function handleFiles(files) {
            const container = document.getElementById('image-preview-container');
            Array.from(files).forEach(file => {
                processFile(file).then(base64 => {
                    uploadedImages.push(base64);
                    const div = document.createElement('div');
                    div.className = "relative group aspect-square rounded-2xl overflow-hidden border-2 border-slate-100";
                    
                    if (base64.startsWith('data:application/pdf')) {
                        div.innerHTML = `<div class="w-full h-full bg-red-50 flex flex-col items-center justify-center text-red-500"><span class="text-2xl font-bold">PDF</span><span class="text-[10px]">Anexado</span></div>`;
                    } else {
                        div.innerHTML = `<img src="${base64}" class="w-full h-full object-cover">`;
                    }
                    container.insertBefore(div, container.lastElementChild);
                });
            });
        }

        // --- CATEGORY DROPDOWN LOGIC ---
        function toggleCategoryList() {
            const dropdown = document.getElementById('category-dropdown');
            dropdown.classList.toggle('hidden');
        }

        function selectCategory(value) {
            const input = document.getElementById('form-category');
            input.value = value;
            input.setAttribute('readonly', true);
            document.getElementById('category-dropdown').classList.add('hidden');
        }

        function enableCustomCategory() {
            const input = document.getElementById('form-category');
            input.value = '';
            input.removeAttribute('readonly');
            input.focus();
            input.placeholder = "DIGITE A NOVA CATEGORIA...";
            document.getElementById('category-dropdown').classList.add('hidden');
        }

        function handleRecurrenceChange() {
            const rec = document.getElementById('form-recurrence').value;
            const divDue = document.getElementById('div-due-day');
            const divInst = document.getElementById('div-installments');
            
            divDue.classList.toggle('hidden', rec === 'unica');
            divInst.classList.toggle('hidden', rec === 'unica');
            
            if (rec === 'unica') document.getElementById('form-due-day').value = '';
        }

        function toggleInstallmentType() {
            const type = document.getElementById('form-installments-type').value;
            document.getElementById('div-installments-input').classList.toggle('hidden', type === 'subscription');
        }

        function saveExpense(e) {
            e.preventDefault();
            
            const title = document.getElementById('form-title').value;
            const amount = parseFloat(document.getElementById('form-amount').value.replace(/\./g, '').replace(',', '.'));
            const date = document.getElementById('form-date').value;
            const category = document.getElementById('form-category').value.toUpperCase();
            const recurrence = document.getElementById('form-recurrence').value;
            const dueDay = document.getElementById('form-due-day').value;
            const notes = document.getElementById('form-notes').value;
            const paymentMethod = document.getElementById('form-payment').value;
            
            const installmentsType = document.getElementById('form-installments-type') ? document.getElementById('form-installments-type').value : 'fixed';
            let installments = parseInt(document.getElementById('form-installments').value) || 1;
            const isPaid = document.getElementById('form-paid').checked;

            // Objeto Base (A "Caixa")
            const newExpense = {
                id: Date.now().toString(),
                title, amount, date, category, recurrence, dueDay, notes,
                paymentMethod,
                paymentHistory: [], // A "Sub-caixa" para pagamentos realizados
                status: 'pending',
                createdAt: Date.now()
            };

            if (recurrence !== 'unica') {
                if (installmentsType === 'fixed') {
                    newExpense.installmentsTotal = installments;
                    newExpense.installmentsPaid = 0;
                    newExpense.title = title + (title.toLowerCase().includes('parcela') ? '' : ' (Parcelado)');
                } else {
                    newExpense.isSubscription = true;
                    newExpense.title = title + (title.toLowerCase().includes('mensal') ? '' : ' (Mensalidade)');
                }
            }

            // Se j√° foi pago na cria√ß√£o
            if (isPaid) {
                const historyItem = {
                    datePaid: new Date().toISOString().split('T')[0],
                    amount: amount,
                    originalDate: date,
                    notes: notes,
                    receiptImages: []
                };
                newExpense.paymentHistory.push(historyItem);

                if (recurrence === 'unica') {
                    newExpense.status = 'paid';
                } else {
                    // Avan√ßar data automaticamente
                    if (newExpense.installmentsTotal) {
                        newExpense.installmentsPaid = 1;
                        if (newExpense.installmentsPaid >= newExpense.installmentsTotal) {
                            newExpense.status = 'paid';
                        } else {
                            newExpense.date = calculateNextDue(date, recurrence, dueDay || date.split('-')[2]);
                        }
                    } else {
                        newExpense.date = calculateNextDue(date, recurrence, dueDay || date.split('-')[2]);
                    }
                }
            }

            if (firebaseApi) {
                const { db, ref, set } = firebaseApi;
                set(ref(db, `expenses/${currentUser}/${newExpense.id}`), newExpense).then(() => switchView('list'));
            }
        }

        function deleteExpense(id) {
            const exp = expenses.find(e => e.id === id);
            if (!exp) return;

            if (confirm("Deseja realmente excluir este registro?")) {
                if (firebaseApi) {
                    const { db, ref, remove } = firebaseApi;
                    remove(ref(db, `expenses/${currentUser}/${id}`));
                }
                renderView();
            }
        }

        function handleSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => applyFilters(), 300);
        }

        function applyFilters() {
            if (currentView === 'list') renderList(document.getElementById('content-area'));
        }

        function updateDashboardDate(date) {
            dashboardDate = date;
            renderDashboard(document.getElementById('content-area'));
        }

        function setDashboardMode(mode) {
            dashboardMode = mode;
            renderDashboard(document.getElementById('content-area'));
        }

        function updateCustomDates(type, value) {
            if (type === 'start') dashboardCustomStart = value;
            else dashboardCustomEnd = value;
            renderDashboard(document.getElementById('content-area'));
        }

        function initDashboardCharts(data) {
            if (dashboardCharts.bar) dashboardCharts.bar.destroy();
            if (dashboardCharts.pie) dashboardCharts.pie.destroy();

            const uniqueCats = [...new Set(data.map(e => e.category))];
            const dataMap = {};
            uniqueCats.forEach(c => dataMap[c] = 0);
            data.forEach(e => dataMap[e.category] += parseFloat(e.amount));

            const activeCats = uniqueCats.filter(c => dataMap[c] > 0);
            const activeData = activeCats.map(c => dataMap[c]);

            // Bar Chart
            const ctxBar = document.getElementById('categoryChart').getContext('2d');
            dashboardCharts.bar = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: activeCats,
                    datasets: [{
                        label: 'Gastos por Categoria',
                        data: activeData,
                        backgroundColor: '#6366f1',
                        borderRadius: 8,
                        barThickness: 30
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' }, border: { display: false } }, x: { grid: { display: false }, border: { display: false } } }
                }
            });

            // Pie Chart
            const ctxPie = document.getElementById('distributionChart').getContext('2d');
            dashboardCharts.pie = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: activeCats,
                    datasets: [{
                        data: activeData,
                        backgroundColor: ['#6366f1', '#10b981', '#3b82f6', '#f43f5e', '#8b5cf6', '#f59e0b', '#ec4899', '#64748b'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { size: 10 } } } },
                    cutout: '70%'
                }
            });
        }

        function openGallery(id, index) {
            const exp = expenses.find(e => e.id === id);
            if (!exp || !exp.receiptImages) return;
            const images = exp.receiptImages;
            
            const img = document.getElementById('gallery-img');
            const thumbs = document.getElementById('gallery-thumbs');
            
            if (images[index].startsWith('data:application/pdf')) {
                // Se for PDF, abre em nova aba e fecha modal (ou mostra placeholder)
                const pdfWindow = window.open("");
                pdfWindow.document.write(`<iframe width='100%' height='100%' src='${images[index]}'></iframe>`);
                return;
            } else {
                img.src = images[index];
            }
            
            thumbs.innerHTML = images.map((src, i) => `
                <button onclick='updateGallery("${src}", ${i})' class="w-16 h-16 rounded-xl border-2 transition-all overflow-hidden ${i === index ? 'border-indigo-500 scale-110' : 'border-transparent opacity-50'}">
                    ${src.startsWith('data:application/pdf') ? '<div class="w-full h-full bg-red-50 flex items-center justify-center text-[8px] font-bold text-red-500">PDF</div>' : `<img src="${src}" class="w-full h-full object-cover">`}
                </button>
            `).join('');
            
            toggleModal('gallery-modal', true);
        }

        function updateGallery(src, idx) {
            if (src.startsWith('data:application/pdf')) {
                const pdfWindow = window.open("");
                pdfWindow.document.write(`<iframe width='100%' height='100%' src='${src}'></iframe>`);
                return;
            }
            document.getElementById('gallery-img').src = src;
            const btns = document.getElementById('gallery-thumbs').querySelectorAll('button');
            btns.forEach((b, i) => {
                b.classList.toggle('border-indigo-500', i === idx);
                b.classList.toggle('scale-110', i === idx);
                b.classList.toggle('opacity-50', i !== idx);
            });
        }

        function downloadCurrentImage() {
            const img = document.getElementById('gallery-img');
            const a = document.createElement('a');
            a.href = img.src;
            a.download = `comprovante_${Date.now()}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function handleExport() {
            const format = document.querySelector('input[name="export-format"]:checked').value;
            if (format === 'xml') {
                exportToXML();
            } else {
                exportToCSV();
            }
        }

        function exportToCSV() {
            const start = document.getElementById('export-start').value;
            const end = document.getElementById('export-end').value;
            const filtered = expenses.filter(e => e.date >= start && e.date <= end);

            if (filtered.length === 0) {
                alert("Nenhum registro no per√≠odo.");
                return;
            }

            let csv = "ID;Titulo;Valor;Data;Categoria;Recorrencia;Notas\n";
            filtered.forEach(e => {
                const title = (e.title || "").replace(/;/g, " ");
                const amount = parseFloat(e.amount).toLocaleString('pt-BR', {minimumFractionDigits: 2, useGrouping: false});
                const date = e.date.split('-').reverse().join('/');
                const category = e.category;
                const recurrence = e.recurrence || "unica";
                const notes = (e.notes || "").replace(/;/g, " ").replace(/\n/g, " ");
                csv += `${e.id};${title};${amount};${date};${category};${recurrence};${notes}\n`;
            });

            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `financeiro_${start}_a_${end}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            toggleModal('export-modal', false);
        }

        function exportToXML() {
            const start = document.getElementById('export-start').value;
            const end = document.getElementById('export-end').value;
            const filtered = expenses.filter(e => e.date >= start && e.date <= end);

            if (filtered.length === 0) {
                alert("Nenhum registro no per√≠odo.");
                return;
            }

            let xml = `<?xml version="1.0" encoding="UTF-8"?>\n<RelatorioFinanceiro>\n  <Periodo>\n    <Inicio>${start}</Inicio>\n    <Fim>${end}</Fim>\n  </Periodo>\n  <Mensalidades>\n`;
            filtered.forEach(e => {
                xml += `    <Mensalidade id="${e.id}">\n      <Titulo>${e.title}</Titulo>\n      <Valor>${parseFloat(e.amount).toFixed(2)}</Valor>\n      <Data>${e.date}</Data>\n      <Categoria>${e.category}</Categoria>\n     </Mensalidade>\n`;
            });
            xml += `  </Mensalidades>\n</RelatorioFinanceiro>`;

            const blob = new Blob([xml], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `financeiro_${start}_a_${end}.xml`;
            a.click();
            toggleModal('export-modal', false);
        }

        function handleEmailSend() {
            const email = document.getElementById('accountant-email').value;
            const start = document.getElementById('email-start').value;
            const end = document.getElementById('email-end').value;
            
            if (!email) return alert("Por favor, digite o e-mail do contador.");
            if (!start || !end) return alert("Selecione o per√≠odo.");

            if (document.getElementById('save-email-check').checked) {
                localStorage.setItem('accountant_email', email);
            } else {
                localStorage.removeItem('accountant_email');
            }

            const filtered = expenses.filter(e => e.date >= start && e.date <= end);
            if (filtered.length === 0) return alert("Nenhum registro no per√≠odo.");

            let xml = `<?xml version="1.0" encoding="UTF-8"?>\n<RelatorioFinanceiro>\n  <Periodo>\n    <Inicio>${start}</Inicio>\n    <Fim>${end}</Fim>\n  </Periodo>\n  <Mensalidades>\n`;
            filtered.forEach(e => {
                xml += `    <Mensalidade id="${e.id}">\n      <Titulo>${e.title}</Titulo>\n      <Valor>${parseFloat(e.amount).toFixed(2)}</Valor>\n      <Data>${e.date}</Data>\n      <Categoria>${e.category}</Categoria>\n     </Mensalidade>\n`;
            });
            xml += `  </Mensalidades>\n</RelatorioFinanceiro>`;

            const blob = new Blob([xml], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `financeiro_${start}_a_${end}.xml`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            const subject = encodeURIComponent(`Relat√≥rio Financeiro - ${start} a ${end}`);
            const body = encodeURIComponent(`Ol√°,\n\nSegue em anexo o relat√≥rio financeiro (XML) referente ao per√≠odo de ${start.split('-').reverse().join('/')} a ${end.split('-').reverse().join('/')}.\n\nAtenciosamente.`);
            
            window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;

            setTimeout(() => {
                alert("O arquivo XML foi baixado no seu dispositivo.\n\nPor favor, anexe-o manualmente na janela de e-mail que foi aberta.");
                toggleModal('email-modal', false);
            }, 1000);
        }

        function downloadBackup() {
            const dataStr = JSON.stringify(expenses, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_contabil_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function restoreBackup(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        if (confirm(`Deseja substituir os dados atuais por ${data.length} registros do backup?`)) {
                            if (firebaseApi) {
                                const updates = {};
                                data.forEach(p => updates[p.id] = p);
                                const { db, ref, set } = firebaseApi;
                                set(ref(db, 'expenses/' + currentUser), updates);
                                alert('Dados restaurados com sucesso!');
                            }
                        }
                    } else {
                        alert('Arquivo de backup inv√°lido: O formato deve ser uma lista de registros.');
                    }
                } catch (err) {
                    alert('Erro ao ler o arquivo JSON. Verifique se o arquivo est√° corrompido.');
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function calculateNextDue(lastDate, recurrence, dueDay) {
            const [y, m, d] = lastDate.split('-').map(Number);
            let targetMonth = m - 1; // JS months 0-11
            let targetYear = y;
            
            let add = 0;
            if (recurrence === 'mensal') add = 1;
            else if (recurrence === 'bimestral') add = 2;
            else if (recurrence === 'trimestral') add = 3;
            else if (recurrence === 'semestral') add = 6;
            
            targetMonth += add;
            targetYear += Math.floor(targetMonth / 12);
            targetMonth = targetMonth % 12;
            
            const daysInMonth = new Date(targetYear, targetMonth + 1, 0).getDate();
            const finalDay = Math.min(parseInt(dueDay), daysInMonth);
            
            const nextDate = new Date(targetYear, targetMonth, finalDay);
            const yearStr = nextDate.getFullYear();
            const monthStr = String(nextDate.getMonth() + 1).padStart(2, '0');
            const dayStr = String(nextDate.getDate()).padStart(2, '0');
            return `${yearStr}-${monthStr}-${dayStr}`;
        }

        function formatCurrency(input) {
            let value = input.value.replace(/\D/g, '');
            value = (Number(value) / 100).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            input.value = value;
        }

        function openDetails(id) {
            const e = expenses.find(exp => exp.id === id);
            if (!e) return;

            // Buscar hist√≥rico interno (sub-caixa) ou fallback para array vazio
            const history = (e.paymentHistory || []).sort((a,b) => new Date(b.datePaid) - new Date(a.datePaid));

            const container = document.getElementById('details-content');
            container.innerHTML = `
                <div class="flex items-center gap-4 mb-2">
                    <div class="w-16 h-16 rounded-2xl bg-indigo-50 flex items-center justify-center text-3xl">
                        ${getIcon(e.category)}
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white">${e.title}</h2>
                        <span class="inline-block px-3 py-1 bg-slate-100 text-slate-600 text-xs font-bold rounded-lg uppercase mt-1">${e.category}</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-4 bg-slate-50 dark:bg-slate-700 rounded-2xl">
                        <p class="text-xs font-bold text-slate-400 uppercase">Valor</p>
                        <p class="text-xl font-black text-indigo-600">R$ ${parseFloat(e.amount).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                    </div>
                    <div class="p-4 bg-slate-50 dark:bg-slate-700 rounded-2xl">
                        <p class="text-xs font-bold text-slate-400 uppercase">Data</p>
                        <p class="text-xl font-bold text-slate-700 dark:text-white">${e.date.split('-').reverse().join('/')}</p>
                    </div>
                </div>

                ${e.notes ? `<div class="p-4 bg-yellow-50 rounded-2xl border border-yellow-100"><p class="text-sm text-yellow-800 italic">"${e.notes}"</p></div>` : ''}

                ${e.receiptImages && e.receiptImages.length > 0 ? `
                    <div>
                        <p class="text-sm font-bold text-slate-800 mb-3">Comprovantes Anexados</p>
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                            ${e.receiptImages.map((img, idx) => `
                                <div onclick='openGallery("${e.id}", ${idx})' class="aspect-square rounded-xl overflow-hidden border border-slate-200 dark:border-slate-600 cursor-pointer hover:opacity-80 transition-opacity">
                                    ${img.startsWith('data:application/pdf') ? 
                                        '<div class="w-full h-full bg-red-50 flex flex-col items-center justify-center text-red-500"><span class="text-2xl font-bold">PDF</span></div>' : 
                                        `<img src="${img}" class="w-full h-full object-cover">`
                                    }
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Se√ß√£o Hist√≥rico -->
                <div class="mt-6 pt-6 border-t border-slate-100 dark:border-slate-700">
                    <button onclick="document.getElementById('history-list').classList.toggle('hidden')" class="flex items-center justify-between w-full text-left group">
                        <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider group-hover:text-indigo-600 transition-colors">Hist√≥rico de Pagamentos (${history.length})</h3>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400 group-hover:text-indigo-600"><polyline points="6 9 12 15 18 9"/></svg>
                    </button>
                    
                    <div id="history-list" class="hidden mt-4 space-y-2">
                        ${history.length > 0 ? history.map((h, idx) => `
                            <div onclick="openHistoryDetails('${e.id}', ${idx})" class="cursor-pointer flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl border border-transparent hover:border-indigo-100 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-all">
                                <div class="flex items-center gap-3">
                                    <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                                    <span class="text-sm font-bold text-slate-700 dark:text-slate-200">${h.datePaid.split('-').reverse().join('/')} <span class="text-xs text-slate-400 font-normal">(Ref: ${h.originalDate.split('-').reverse().join('/')})</span></span>
                                </div>
                                <span class="text-sm font-bold text-emerald-600">R$ ${parseFloat(h.amount).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                            </div>
                        `).join('') : '<p class="text-xs text-slate-400 italic py-2">Nenhum hist√≥rico encontrado.</p>'}
                    </div>
                </div>
            `;
            toggleModal('details-modal', true);
        }

        function openHistoryDetails(id, sortedIndex) {
            const e = expenses.find(exp => exp.id === id);
            if (!e || !e.paymentHistory) return;
            
            // Re-sort to match the index from openDetails
            const history = [...e.paymentHistory].sort((a,b) => new Date(b.datePaid) - new Date(a.datePaid));
            const item = history[sortedIndex];
            if (!item) return;

            const container = document.getElementById('history-content');
            container.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-3 bg-slate-50 dark:bg-slate-700 rounded-xl">
                            <p class="text-xs font-bold text-slate-400 uppercase">Data Pagamento</p>
                            <p class="text-base font-bold text-slate-800 dark:text-white">${item.datePaid.split('-').reverse().join('/')}</p>
                        </div>
                        <div class="p-3 bg-emerald-50 dark:bg-emerald-900/20 rounded-xl">
                            <p class="text-xs font-bold text-emerald-600/70 uppercase">Valor Pago</p>
                            <p class="text-base font-black text-emerald-600">R$ ${parseFloat(item.amount).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                        </div>
                    </div>
                    
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase mb-1">Referente ao Vencimento</p>
                        <p class="text-sm font-bold text-slate-700 dark:text-slate-300">${item.originalDate.split('-').reverse().join('/')}</p>
                    </div>

                    ${item.notes ? `
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase mb-1">Anota√ß√µes</p>
                        <div class="p-3 bg-slate-50 dark:bg-slate-700 rounded-xl border border-slate-100 dark:border-slate-600">
                            <p class="text-sm text-slate-600 dark:text-slate-300 italic">"${item.notes}"</p>
                        </div>
                    </div>` : ''}
                    
                    ${item.receiptImages && item.receiptImages.length > 0 ? `
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase mb-2">Comprovantes Anexados</p>
                        <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                            ${item.receiptImages.map((img, i) => `
                                <div onclick="openHistoryGallery('${id}', ${sortedIndex}, ${i})" class="flex-shrink-0 w-16 h-16 rounded-lg border border-slate-200 dark:border-slate-600 overflow-hidden cursor-pointer hover:opacity-80 transition-opacity">
                                    ${img.startsWith('data:application/pdf') ? 
                                        '<div class="w-full h-full bg-red-50 flex items-center justify-center text-[8px] font-bold text-red-500">PDF</div>' : 
                                        `<img src="${img}" class="w-full h-full object-cover">`
                                    }
                                </div>
                            `).join('')}
                        </div>
                    </div>` : ''}
                </div>
            `;
            toggleModal('history-modal', true);
        }

        function openHistoryGallery(id, historyIndex, imgIndex) {
            const e = expenses.find(exp => exp.id === id);
            if (!e) return;
            const history = [...e.paymentHistory].sort((a,b) => new Date(b.datePaid) - new Date(a.datePaid));
            const item = history[historyIndex];
            if (!item || !item.receiptImages) return;
            
            // Reuse the existing gallery modal logic manually since openGallery is tied to expense.receiptImages
            const images = item.receiptImages;
            const img = document.getElementById('gallery-img');
            const thumbs = document.getElementById('gallery-thumbs');
            
            if (images[imgIndex].startsWith('data:application/pdf')) {
                const pdfWindow = window.open("");
                pdfWindow.document.write(`<iframe width='100%' height='100%' src='${images[imgIndex]}'></iframe>`);
                return;
            } else {
                img.src = images[imgIndex];
            }
            
            thumbs.innerHTML = images.map((src, i) => `
                <button onclick='updateGallery("${src}", ${i})' class="w-16 h-16 rounded-xl border-2 transition-all overflow-hidden ${i === imgIndex ? 'border-indigo-500 scale-110' : 'border-transparent opacity-50'}">
                    ${src.startsWith('data:application/pdf') ? '<div class="w-full h-full bg-red-50 flex items-center justify-center text-[8px] font-bold text-red-500">PDF</div>' : `<img src="${src}" class="w-full h-full object-cover">`}
                </button>
            `).join('');
            
            toggleModal('gallery-modal', true);
        }

        function getIcon(cat) {
            switch(cat) {
                case 'Habita√ß√£o': return 'üè†';
                case 'Alimenta√ß√£o': return 'üçî';
                case 'Transporte': return 'üöó';
                case 'Contas Fixas': return 'üí°';
                case 'Lazer': return 'üéâ';
                case 'Sa√∫de': return 'üè•';
                case 'Educa√ß√£o': return 'üéì';
                default: return 'üì¶';
            }
        }
    </script>
</body>
</html>